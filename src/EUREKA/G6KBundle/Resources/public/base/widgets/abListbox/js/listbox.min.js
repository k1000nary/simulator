/*!
 * Accessible Listbox v1.0.0 
 * Copyright 2015 Eureka2, Jacques Archimï¿½de.
 * Based on the example of the Open AJAX Alliance Accessibility Tools Task Force : http://oaa-accessibility.org/example/9/
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */
(function(n){if(typeof define=="function"&&define.amd)define(["jquery"],n);else if(typeof exports=="object")n(require("jquery"));else{if(typeof jQuery=="undefined")throw new Error("Listbox's JavaScript requires jQuery");n(jQuery)}})(function(n){"use strict";function u(){this.backspace=8;this.tab=9;this.enter=13;this.esc=27;this.space=32;this.pageup=33;this.pagedown=34;this.end=35;this.home=36;this.up=38;this.down=40;this.del=46}function t(i,f){var o=this,e=n(i),h,l,s,c;this.options=n.extend({},t.DEFAULTS,f);this.id=e.attr("id")||"listbox-"+Math.floor(Math.random()*1e5);this.size=e.attr("size")||this.options.size;h=r.join("");h=h.replace(/COMBOBOXID/g,this.id+"");this.$listbox=n(h);n.each(e[0].attributes,function(t,i){n.inArray(i.name,["id","name","class","style","value","tabindex","required","aria-controls"])<0&&o.$listbox.attr(i.name,i.value)});this.$listbox.css("position","relative");this.hideObject(this.$listbox.find("input"));this.$label=e.parents().find("label[for="+this.id+"]");!this.$listbox.attr("aria-label")&&this.$label.length&&this.$label.attr("id")&&this.$listbox.attr("aria-labelledby",this.$label.attr("id"));e.attr("required")&&this.$listbox.attr("aria-required",!0);this.$listbox.attr("aria-controls",this.id);this.$listbox.attr("aria-label",e.attr("aria-label"));this.$listbox.addClass(this.options.theme);this.keys=new u;this.$edit=this.$listbox.find(".listbox-edit");this.$button=this.$listbox.find(".listbox-button");this.$list=this.$listbox.find(".listbox-items");l=e.find("option");s=!1;e.children().each(function(){if(this.tagName=="OPTGROUP"){var t=n('<li class="listbox-itemgroup" tabindex="-1">'+n(this).attr("label")+"<\/li>");o.$list.append(t);t.attr("id","itemgroup"+o.id+"-"+o.$list.children().length);t.css("width",n(this).css("width"));n(this).find("option").each(function(){s=o.populateList(n(this),!0)||s})}else s=o.populateList(n(this),!1)||s});this.$items=this.$list.find("li.listbox-item");s||this.$items.eq(0).addClass("selected");this.$group=this.$listbox.find(".input-group");this.$input=this.$listbox.find("input");this.$input.attr("name",e.attr("name"));e.parent(".input-group").length==0?e.replaceWith(this.$listbox):(c=e.parent(".input-group").eq(0),c.parent(".form-group").length>0&&this.$listbox.removeClass("form-group"),c.replaceWith(this.$listbox));this.$input.data("alb.listbox",this);this.$initial;this.$selected;this.$focused;this.timer=null;this.init();this.bindHandlers()}var r=['<div class="listbox form-group" tabindex="0">','\t<div class="input-group">','\t\t<div id="listbox-edit-COMBOBOXID" class="form-control" aria-autocomplete="none" aria-readonly="true" tabindex="-1">','\t\t\t<span class="listbox-edit" aria-live="assertive"> <\/span>',"\t\t<\/div>",'\t\t<a class="listbox-button input-group-addon" role="button" aria-haspopup="true" aria-controls="listbox-items-COMBOBOXID" tabindex="-1">','\t\t\t<span class="glyphicon glyphicon-menu-down" title="Ouvrir ou fermer la liste"><\/span>',"\t\t<\/a>","\t<\/div>",'\t<ul class="listbox-items" id="listbox-items-COMBOBOXID" tabindex="-1" aria-expanded="true" role="listbox">',"\t<\/ul>",'\t<input class="listbox-input" type="text" id="COMBOBOXID" name="" value="" aria-hidden="true" />',"<\/div>"],i;t.VERSION="1.0.0";t.DEFAULTS={size:10,theme:"default"};t.prototype.init=function(){this.hideObject(this.$list);this.$list.attr("aria-expanded","false");this.$selected=this.$initial=this.$items.filter(".selected");this.$list.attr("aria-activedescendant",this.$selected.attr("id"));this.$selected.length>0&&(this.$edit.text(this.$selected.text()),this.$input.attr("value",this.$selected.attr("data-value")),this.$input.trigger("change"))};t.prototype.populateList=function(t,i){var u=this,f=!1,e=t.is("[value]")?t.attr("value"):t.text(),o=i?" listbox-item-nested":"",r=n('<li role="option" class="listbox-item'+o+'" tabindex="-1" data-value="'+e+'">'+t.text()+"<\/li>");return t.attr("selected")&&(r.addClass("selected"),f=!0),u.$list.append(r),r.attr("id","item"+u.id+"-"+u.$list.children().length),r.css("width",t.css("width")),f};t.prototype.bindEditboxHandlers=function(){var t=this;this.$listbox.keydown(function(i){return t.handleEditKeyDown(n(this),i)});this.$listbox.keypress(function(i){return t.handleEditKeyPress(n(this),i)});this.$listbox.blur(function(i){return t.$edit.css("outline",0),t.handleListBlur(n(this),i)});this.$listbox.focus(function(){return t.$edit.css("outline","thin dotted"),!1});n("label[for="+this.id+"]").click(function(){console.log("clicked");t.$listbox.focus()})};t.prototype.bindButtonHandlers=function(){var t=this;this.$group.click(function(i){return t.handleButtonClick(n(this),i)});this.$group.mouseover(function(i){return t.handleButtonMouseOver(n(this),i)});this.$group.mouseout(function(i){return t.handleButtonMouseOut(n(this),i)});this.$group.mousedown(function(i){return t.handleButtonMouseDown(n(this),i)});this.$group.mouseup(function(i){return t.handleButtonMouseUp(n(this),i)})};t.prototype.bindListboxHandlers=function(){var t=this;this.$list.focus(function(i){return t.handleListFocus(n(this),i)});this.$list.blur(function(i){return t.handleListBlur(n(this),i)})};t.prototype.bindOptionsHandlers=function(){var t=this;this.$items.keydown(function(i){return t.handleOptionKeyDown(n(this),i)});this.$items.keypress(function(i){return t.handleOptionKeyPress(n(this),i)});this.$items.click(function(i){return t.handleOptionClick(n(this),i)});this.$items.focus(function(i){return t.handleListFocus(n(this),i)});this.$items.blur(function(i){return t.handleListBlur(n(this),i)})};t.prototype.bindHandlers=function(){this.bindEditboxHandlers();this.bindButtonHandlers();this.bindListboxHandlers();this.bindOptionsHandlers()};t.prototype.isOpen=function(){return this.$list.attr("aria-expanded")=="true"?!0:!1};t.prototype.closeList=function(n){var t=this.$items.filter(".selected");n==!0&&(t=this.$selected,this.$items.removeClass("selected"),t.addClass("selected"));this.$list.fadeOut().attr("aria-expanded","false");this.$edit.focus()};t.prototype.openList=function(t){var i=this.$items.filter(".selected");t==!0&&(this.$selected.length==0&&this.selectOption(this.$items.first()),i=this.$selected,this.$items.removeClass("selected"),i.addClass("selected"));parseInt(this.$items.css("width"),10)>parseInt(this.$group.css("width"),10)?this.$list.css("width",this.$items.css("width")):(this.$list.css("width",this.$group.css("width")),this.$items.css("width",this.$group.css("width")));var r=this.$list.outerHeight(),u=this.$group.offset().top,f=this.$group.outerHeight(!0),o=Math.floor(u-n(window).scrollTop()),e=Math.floor(n(window).height()-(u+f-n(window).scrollTop()));e<r&&e<o?this.$list.css("top",-r+"px"):this.$list.css("top",f+"px");this.$list.fadeIn().attr("aria-expanded","true");this.$list.scrollTop(this.calcOffset(i));this.$selected.focus()};t.prototype.toggleList=function(n){this.isOpen()==!0?this.closeList(n):this.openList(n)};t.prototype.selectOption=function(n){this.$selected.length>0&&this.$selected.removeClass("selected");n.addClass("selected");this.$selected=n;this.$list.attr("aria-activedescendant",this.$selected.attr("id"));this.$edit.text(n.text());this.$input.attr("value",n.attr("data-value"));this.$input.trigger("change")};t.prototype.calcOffset=function(n){for(var i=0,r=this.$items.index(n),t=0;t<r;t++)i+=this.$items.eq(t).outerHeight();return i};t.prototype.handleButtonClick=function(n,t){return t.stopPropagation(),!1};t.prototype.handleButtonMouseOver=function(n,t){return t.stopPropagation(),!1};t.prototype.handleButtonMouseOut=function(n,t){return t.stopPropagation(),!1};t.prototype.handleButtonMouseDown=function(n,t){return this.toggleList(!0),t.stopPropagation(),!1};t.prototype.handleButtonMouseUp=function(n,t){return t.stopPropagation(),!1};t.prototype.handleOptionKeyDown=function(n,t){var r=this.$items.index(n),e,s,o,u,f,i;if(t.ctrlKey)return!0;switch(t.keyCode){case this.keys.tab:return n.text()!=this.$selected.text()&&this.selectOption(n),this.closeList(!1),!0;case this.keys.esc:return this.closeList(!0),t.stopPropagation(),!1;case this.keys.enter:case this.keys.space:return n.text()!=this.$selected.text()&&this.selectOption(n),this.closeList(!1),t.stopPropagation(),!1;case this.keys.up:return t.altKey?this.toggleList(!0):r>0&&(e=this.$items.eq(r-1),n.removeClass("selected"),e.addClass("selected"),this.$list.scrollTop(this.calcOffset(e)),e.focus()),t.stopPropagation(),!1;case this.keys.down:return t.altKey?this.toggleList(!0):r<this.$items.length-1&&(i=this.$items.eq(r+1),n.removeClass("selected"),i.addClass("selected"),this.$list.scrollTop(this.calcOffset(i)),i.focus()),t.stopPropagation(),!1;case this.keys.home:return s=this.$items.first(),this.$items.eq(r).removeClass("selected"),s.addClass("selected"),this.$list.scrollTop(0),s.focus(),t.stopPropagation(),!1;case this.keys.end:return o=this.$items.last(),this.$items.eq(r).removeClass("selected"),o.addClass("selected"),this.$list.scrollTop(this.calcOffset(o)),o.focus(),t.stopPropagation(),!1;default:for(u=null,f=r+1;f<this.$items.length;f++)if(i=this.$items.eq(f),i.text().toLowerCase().charAt(0)==t.key){u=i;break}if(u==null)for(f=0;f<r;f++)if(i=this.$items.eq(f),i.text().toLowerCase().charAt(0)==t.key){u=i;break}if(u!=null)return n.removeClass("selected"),u.addClass("selected"),this.$list.scrollTop(this.calcOffset(u)),u.focus(),t.stopPropagation(),!1}return!0};t.prototype.handleOptionKeyPress=function(n,t){var i=this.$items.index(n);if(t.altKey||t.ctrlKey||t.shiftKey)return!0;switch(t.keyCode){case this.keys.esc:case this.keys.enter:case this.keys.space:case this.keys.up:case this.keys.down:case this.keys.home:case this.keys.end:return t.stopPropagation(),!1}return!0};t.prototype.handleEditKeyDown=function(n,t){var u=this.$items.index(this.$selected),e,f,r,i;if(t.altKey&&(t.keyCode==this.keys.up||t.keyCode==this.keys.down))return this.toggleList(!0),t.stopPropagation(),!1;switch(t.keyCode){case this.keys.backspace:case this.keys.del:return this.$edit.text(this.$selected.text()),this.$input.attr("value",this.$selected.attr("data-value")),this.$input.trigger("change"),t.stopPropagation(),!1;case this.keys.enter:case this.keys.space:return this.toggleList(!1),t.stopPropagation(),!1;case this.keys.up:return u>0&&(e=this.$items.eq(u-1),this.selectOption(e)),t.stopPropagation(),!1;case this.keys.down:return u<this.$items.length-1&&(i=this.$items.eq(u+1),this.selectOption(i)),t.stopPropagation(),!1;default:for(f=null,r=u+1;r<this.$items.length;r++)if(i=this.$items.eq(r),i.text().toLowerCase().charAt(0)==t.key){f=i;break}if(f==null)for(r=0;r<u;r++)if(i=this.$items.eq(r),i.text().toLowerCase().charAt(0)==t.key){f=i;break}if(f!=null)return this.selectOption(f),t.stopPropagation(),!1}return!0};t.prototype.handleEditKeyPress=function(n,t){var i=this.$items.index(n);if(t.altKey&&(t.keyCode==this.keys.up||t.keyCode==this.keys.down))return t.stopPropagation(),!1;switch(t.keyCode){case this.keys.esc:case this.keys.space:case this.keys.enter:return t.stopPropagation(),!1}return!0};t.prototype.handleOptionClick=function(n,t){return this.selectOption(n),this.closeList(!1),t.stopPropagation(),!1};t.prototype.handleListFocus=function(){return this.timer!=null&&(window.clearTimeout(this.timer),this.timer=null),!0};t.prototype.handleListBlur=function(){var n=this;return this.selectOption(this.$items.filter(".selected")),this.isOpen()==!0&&(this.timer=window.setTimeout(function(){n.closeList(!1)},40)),!0};t.prototype.hideObject=function(n){n.attr("aria-hidden",!0);n.hide()};t.prototype.showObject=function(n){n.attr("aria-hidden",!1);n.show()};t.prototype.theme=function(n){return n!=null&&(this.$listbox.removeClass(this.options.theme),this.options.theme=n,this.$listbox.addClass(this.options.theme)),this.options.theme};t.prototype.size=function(n){return n!=null&&(this.options.size=parseInt(n,10)),this.options.size};t.prototype.reset=function(){return this.$selected.length>0&&this.$selected.removeClass("selected"),this.$initial.addClass("selected"),this.$selected=this.$initial,this.$edit.text(this.$initial.text()),this.$input.attr("value",this.$initial.attr("data-value")),this.$initial.attr("data-value")};t.prototype.update=function(){var i=this,t;return this.$selected.length>0&&this.$selected.removeClass("selected"),t=this.$input.val(),this.$list.children().each(function(){if(n(this).attr("data-value")==t)return n(this).addClass("selected"),i.$selected=n(this),i.$edit.text(n(this).text()),!1}),t};t.prototype.empty=function(){return this.$list.empty(),this.$items=null,null};t.prototype.addItems=function(t){var i=this;return n.each(t,function(){var t=n('<li role="option" class="listbox-item" tabindex="-1" data-value="'+this.value+'">'+this.text+"<\/li>");this.selected&&t.addClass("selected");i.$list.append(t);t.attr("id","item"+i.id+"-"+i.$list.children().length)}),this.$items=this.$list.find("li.listbox-item"),this.selectOption(this.$items.filter(".selected")),this.bindOptionsHandlers(),null};t.prototype.setItems=function(n){this.empty();this.addItems(n)};t.prototype.showItem=function(t){var i=this,r,f,u;if(t!=null){if(r=i.$list.find("li[data-value="+t+"]"),r.length>0)return;if(r=i.$list.data("alb.item-"+t),!r)return;f=r.data("alb.pos");u=i.$items.length-1;u==-1?i.$list.prepend(r):i.$items.each(function(t,i){var e=n(i);return e.data("alb.pos")>f?(e.before(r),!1):t==u?(e.after(r),!1):void 0});i.$items=i.$list.find("li.listbox-item");i.selectOption(i.$items.filter(".selected"));i.bindOptionsHandlers()}};t.prototype.hideItem=function(t){var i=this,r,u,f;if(t!=null){if(r=i.$list.find("li[data-value="+t+"]"),!r.length)return;i.$list.data("alb.itemsModified")||(i.$items.each(function(t,i){n(i).data("alb.pos",t)}),i.$list.data("alb.itemsModified",!0));r.hasClass("selected")&&i.$items.length>1&&(u=i.$items.index(r),f=u<i.$items.length-1?this.$items.eq(u+1):i.$items.first(),r.removeClass("selected"),f.addClass("selected"));i.$list.data("alb.item-"+t,r.detach());i.$items=i.$list.find("li.listbox-item");i.selectOption(i.$items.filter(".selected"));i.bindOptionsHandlers()}};i=n.fn.listbox;n.fn.listbox=function(i,r){if(typeof i=="string"&&n(this).length==1){var u=n(this).eq(0).data("alb.listbox");if(u)return u[i](r)}else return this.each(function(){var f=n(this),u=f.data("alb.listbox"),e=n.extend({},t.DEFAULTS,f.data(),typeof i=="object"&&i);!u&&e.toggle&&i=="show"&&(i=!i);u||f.data("alb.listbox",u=new t(this,e));typeof i=="string"&&u[i](r)})};n.fn.listbox.Constructor=t;n.fn.listbox.noConflict=function(){return n.fn.listbox=i,this}})